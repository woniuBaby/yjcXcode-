# IOS启动优化方案

## **减少动态库**

- 减少动态库数量,官方建议动态库数量小于 6 个
- 推荐的方式是动态库转静态库，因为还能额外减少包大小。另外一个方式是合并动态库，但实践下来可操作性不大。最后一点要提的是，不要链接那些用不到的库（包括系统），因为会拖慢创建闭包的速度。

## **代码瘦身**

- 合并或删除无效的ObjC类、Category、方法、C++ 静态全局变量等

## **+load 迁移**

- +load 除了方法本身的耗时，还会引起大量 Page In，另外 +load 的存在对 App 稳定性也是冲击，因为 Crash 了捕获不到。

## **静态初始化迁移**

- 静态初始化和 +load 方法一样也会引起大量 Page In，一般来自 C++代码，比如网络或者特效的库。另外有些静态初始化是通过头文件引入进来的，可以通过预处理来确认。
- std:string 转换成 const char *
- 静态变量移动到方法内部，因为方法内部的静态变量会在方法第一次调用的时候初始化

## **使用启动器**

- 全局并发调度：比如 AB 任务并发，C 任务等待 AB 执行完毕，框架调度还能减少线程数量和控制优先级
- 延迟执行：提供一些时机，业务可以做预热性质的初始化
- 精细化监控：所有任务的耗时都能监控到，线下自动化监控也能受益
- 管控：启动任务的顺序调整，新增/删除都能通过 Code Review 管控

## **下线或延迟三方sdk**

- 有些三方 SDK 的启动耗时很高，比如 Fabric，抖音下线了 Fabric 后启动速度 pct50 快了 70ms 左右。
- 除了下线，很多 SDK 是可以延迟的，比如分享和登录的 SDK。此外，在接入 SDK 之前可以先评估下对启动性能的影响，如果影响较大是可以反馈给 SDK 的提供方去修改的，尤其是付费的 SDK，他们其实很愿意配合做一些修改。

## **高频次方法加一层内存缓存**

- 有些方法的单个耗时不高，但是在启动路径上会调用很多次的，这种累计起来的耗时也不低.

## **优化持有锁的线程**

- 锁之所以会影响启动时间，是因为有时候子线程先持有了锁，主线程就需要等待子线程锁释放。还要警惕系统会有很多隐藏的全局锁，比如 dyld 和 Runtime。

## **合理设置线程任务**

- 线程的数量和优先级都会影响启动时间。可以通过设置 QoS 来配置优先级，两个高优的 QoS 是 User Interactive/Initiated，启动的时候，需要主线程等待的子线程任务都应该设置成高优的,但高优的线程数量不应该多于 CPU 核心数量.

## **不用或少用fishhook**

- fishhook 是一个用来 hook C 函数的库，但这个库的第一次调用耗时很高，最好不要带到线上。Fishhook 是按照下图的方式遍历 Mach-O 的多个段来找函数指针和函数符号名的映射关系，带来的副作用就是要大量的 Page In，对于大型 App 来说在 iPhone X 冷启耗时 200ms+。
- 如果不得不用 fishhook，请在子线程调用，且不要在在_dyld_register_func_for_add_image直接调用 fishhook.

## **优化图片加载的耗时**

- 用 Asset 管理图片而不是直接放在 bundle 里
- 可以在启动的早期开预加载的子线程启动任务
- 在视觉可接受的范围内，压缩页面中的图片大小；

## **首帧渲染优化**

- LottieView：lottie 是 airbnb 用来做 AE 动画的库，但是加载动画的 json 和读图是比较慢的，可以先显示一帧静态图，启动结束后再开始动画，或者子线程预先把图和 json 设置到 lottie cache 里

- Lazy 初始化 View：不要先创建设置成 hidden，这是很不好的习惯

- AutoLayout：AutoLayout 的耗时也是比较高的，但这块往往历史包袱比较重，可以评估 ROI 看看要不要改成 frame

- Loading 动画：App 一般都会有个 loading 动画表示加载中，这个动画最好不要用 gif，线下测量一个 60 帧的 gif 加载耗时接近 70ms  

- [
  转至元数据结尾](http://wiki.meiyou.com/pages/viewpage.action?pageId=108102211#page-metadata-end)

  - 由 [周泽润](http://wiki.meiyou.com/display/~zhouzerun)创建, 最后修改于[五月 12, 2022](http://wiki.meiyou.com/pages/diffpagesbyversion.action?pageId=108102211&selectedPageVersions=4&selectedPageVersions=5)

  [转至元数据起始](http://wiki.meiyou.com/pages/viewpage.action?pageId=108102211#page-metadata-start)

  # IOS启动优化方案

  ## **减少动态库**

  - 减少动态库数量,官方建议动态库数量小于 6 个
  - 推荐的方式是动态库转静态库，因为还能额外减少包大小。另外一个方式是合并动态库，但实践下来可操作性不大。最后一点要提的是，不要链接那些用不到的库（包括系统），因为会拖慢创建闭包的速度。

  ## **代码瘦身**

  - 合并或删除无效的ObjC类、Category、方法、C++ 静态全局变量等

  ## **+load 迁移**

  - +load 除了方法本身的耗时，还会引起大量 Page In，另外 +load 的存在对 App 稳定性也是冲击，因为 Crash 了捕获不到。

  ## **静态初始化迁移**

  - 静态初始化和 +load 方法一样也会引起大量 Page In，一般来自 C++代码，比如网络或者特效的库。另外有些静态初始化是通过头文件引入进来的，可以通过预处理来确认。
  - std:string 转换成 const char *
  - 静态变量移动到方法内部，因为方法内部的静态变量会在方法第一次调用的时候初始化

  ## **使用启动器**

  - 全局并发调度：比如 AB 任务并发，C 任务等待 AB 执行完毕，框架调度还能减少线程数量和控制优先级
  - 延迟执行：提供一些时机，业务可以做预热性质的初始化
  - 精细化监控：所有任务的耗时都能监控到，线下自动化监控也能受益
  - 管控：启动任务的顺序调整，新增/删除都能通过 Code Review 管控

  ## **下线或延迟三方sdk**

  - 有些三方 SDK 的启动耗时很高，比如 Fabric，抖音下线了 Fabric 后启动速度 pct50 快了 70ms 左右。
  - 除了下线，很多 SDK 是可以延迟的，比如分享和登录的 SDK。此外，在接入 SDK 之前可以先评估下对启动性能的影响，如果影响较大是可以反馈给 SDK 的提供方去修改的，尤其是付费的 SDK，他们其实很愿意配合做一些修改。

  ## **高频次方法加一层内存缓存**

  - 有些方法的单个耗时不高，但是在启动路径上会调用很多次的，这种累计起来的耗时也不低.

  ## **优化持有锁的线程**

  - 锁之所以会影响启动时间，是因为有时候子线程先持有了锁，主线程就需要等待子线程锁释放。还要警惕系统会有很多隐藏的全局锁，比如 dyld 和 Runtime。

  ## **合理设置线程任务**

  - 线程的数量和优先级都会影响启动时间。可以通过设置 QoS 来配置优先级，两个高优的 QoS 是 User Interactive/Initiated，启动的时候，需要主线程等待的子线程任务都应该设置成高优的,但高优的线程数量不应该多于 CPU 核心数量.

  ## **不用或少用fishhook**

  - fishhook 是一个用来 hook C 函数的库，但这个库的第一次调用耗时很高，最好不要带到线上。Fishhook 是按照下图的方式遍历 Mach-O 的多个段来找函数指针和函数符号名的映射关系，带来的副作用就是要大量的 Page In，对于大型 App 来说在 iPhone X 冷启耗时 200ms+。
  - 如果不得不用 fishhook，请在子线程调用，且不要在在_dyld_register_func_for_add_image直接调用 fishhook.

  ## **优化图片加载的耗时**

  - 用 Asset 管理图片而不是直接放在 bundle 里
  - 可以在启动的早期开预加载的子线程启动任务
  - 在视觉可接受的范围内，压缩页面中的图片大小；

  ## **首帧渲染优化**

  - LottieView：lottie 是 airbnb 用来做 AE 动画的库，但是加载动画的 json 和读图是比较慢的，可以先显示一帧静态图，启动结束后再开始动画，或者子线程预先把图和 json 设置到 lottie cache 里
  - Lazy 初始化 View：不要先创建设置成 hidden，这是很不好的习惯
  - AutoLayout：AutoLayout 的耗时也是比较高的，但这块往往历史包袱比较重，可以评估 ROI 看看要不要改成 frame
  - Loading 动画：App 一般都会有个 loading 动画表示加载中，这个动画最好不要用 gif，线下测量一个 60 帧的 gif 加载耗时接近 70ms  